<!DOCTYPE html>
<html>
    <head>
        <title>Viewer</title>
        <style>
            body {
                background: black;
                margin: 0px;
                padding: 0px;
                overflow: hidden;
            }

            .media_item {
                transition: .5s opacity;
                opacity: 1;
                width: 100vw;
                height: 100vh;
                position: absolute;
            }

            .media_item.invisible {
                opacity: 0;
                z-index: -999;
            }

            .media_credit {
                position: absolute;
                right: 20px;
                bottom: 20px;
                z-index: 3;
                font-family: "Arial", sans-serif;
                font-weight: bold;
                color: white;
                font-size: 6vh;
                text-shadow: 0px 0px 10px black;
            }

            .media_foreground {
                position: absolute;
                top: 0px;
                left: 0px;
                right: 0px;
                bottom: 0px;
                z-index: 2;
            }

                .media_foreground video, .media_foreground img, .media_foreground audio {
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                    backdrop-filter: blur(30px) brightness(60%);
                    -webkit-backdrop-filter: blur(30px) brightness(60%);
                    -moz-backdrop-filter: blur(30px) brightness(60%);
                    -o-backdrop-filter: blur(30px) brightness(60%);
                    -ms-backdrop-filter: blur(30px) brightness(60%);
                }

            .media_background {
                position: absolute;
                top: 0px;
                left: 0px;
                right: 0px;
                bottom: 0px;
                z-index: 1;
            }

                .media_background video, .media_background img, .media_background audio {
                    width: 100%;
                    height: 100%;
                    transform: scale(130%);
                    object-fit: cover;
                }
        </style>
    </head>
    <body>
        <div id="main">
            <!--<div class="media_item video">
                <div class="media_credit">
                    {{ viewerID | safe }}
                </div>
                <div class="media_foreground">
                    <video src="/medias/test.webm" id="fff"></video>
                </div>
                <div class="media_background">
                    <video src="/medias/test.webm" muted></video>
                </div>
            </div>-->
        </div>


        <script src="/static/js/socket/socket.io.min.js"></script>
        <script>
            // URL du socket
            const socketAddr = '/';

            // ID du viewer en cours
            const viewerID = "{{ viewerID }}";

            // ID des médias armés et en cours de lecture
            var armedMedia = null;
            var takedMedia = null;

            console.log("Viewer ID \""+viewerID+"\"");



            var currentZindex = 9999;

            function generateGUID() {
                return 'yxxxyxyyxyxyxxyxyxyxyxyxyxyxyxyxyxyxyxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function getVideoByTarget(target) {
                let obj = document.getElementById("target-"+target)
            }

            /**
            * Crée une nouvelle structure DOM contenant un nouveau média.
            **/
            function mediaArm(type, src, credit, volume=1, loop=false) {
                let id = generateGUID();

                // Création du nouvel élément
                let dom_media_item = document.createElement("div");
                dom_media_item.classList.add("media_item");
                dom_media_item.classList.add(type);
                dom_media_item.setAttribute("id", "media-item-" + id);
                dom_media_item.style.zIndex = currentZindex--;
                dom_media_item.classList.add("invisible"); // Par défaut l'élément est invisible

                let dom_media_credit = document.createElement("div");
                dom_media_credit.classList.add("media_credit");
                dom_media_credit.innerText = credit;

                let dom_media_foreground = document.createElement("div");
                dom_media_foreground.classList.add("media_foreground");

                let dom_media_background = document.createElement("div");
                dom_media_background.classList.add("media_background");

                let dom_media_foreground_obj = null;
                let dom_media_background_obj = null;

                // On crée les objets média selon le type
                if(type=="video") {
                    dom_media_background_obj = document.createElement("video");
                    dom_media_background_obj.setAttribute("muted", "");
                    dom_media_background_obj.loop = loop;
                    
                    dom_media_foreground_obj = document.createElement("video");
                    dom_media_foreground_obj.setAttribute("volume", volume);
                    dom_media_foreground_obj.loop = loop;
                }
                else if(type=="picture") {
                    dom_media_background_obj = document.createElement("img");
                    dom_media_background_obj.setAttribute("alt", "");

                    dom_media_foreground_obj = document.createElement("img");
                    dom_media_foreground_obj.setAttribute("alt", "");
                }

                // Définition des ID dom
                dom_media_background_obj.setAttribute("id", "media-item-obj-background-" + id);
                dom_media_foreground_obj.setAttribute("id", "media-item-obj-foreground-" + id);

                // Définition des URLs des médias
                dom_media_background_obj.setAttribute("src", "/medias/" + src);
                dom_media_foreground_obj.setAttribute("src", "/medias/" + src);


                // Synchronisation des médias foreground/background
                if(type=="video") {
                    dom_media_foreground_obj.addEventListener("play", function() {
                        dom_media_background_obj.play();
                    });
                    dom_media_foreground_obj.addEventListener("pause", function() {
                        dom_media_background_obj.pause();
                    });
                    dom_media_foreground_obj.addEventListener("seeked", function() {
                        dom_media_background_obj.currentTime = vm.currentTime;
                    });
                }


                // On récupère l'élément parent
                let parentElement = document.getElementById("main");

                dom_media_background.appendChild(dom_media_background_obj);
                dom_media_foreground.appendChild(dom_media_foreground_obj);
                dom_media_item.appendChild(dom_media_credit);
                dom_media_item.appendChild(dom_media_foreground);
                dom_media_item.appendChild(dom_media_background);

                if(parentElement.firstChild === null)
                    parentElement.appendChild(dom_media_item);
                else
                    parentElement.insertBefore(dom_media_item, parentElement.firstChild);

                // On supprime le media armé s'il existe
                if(armedMedia !== null) {
                    let toDelete = document.getElementById("media-item-" + armedMedia);
                    if(toDelete !== null) {
                        toDelete.parentNode.removeChild(toDelete);
                    }
                }

                // On change l'ID du média armé
                armedMedia = id;

            }


            /**
            * Transite un élément armé vers un élément joué
            **/
            function takeArmed() {
                // Seulement s'il y a un élément armé
                if(armedMedia !== null) {
                    let newMedia = document.getElementById("media-item-" + armedMedia);
                    if(newMedia !== null) {
                        // Si un élément joué existe, on le passe en invisible
                        if(takedMedia !== null) {
                            let toHide = document.getElementById("media-item-" + takedMedia);
                            if(toHide !== null) {
                                toHide.classList.add("invisible");
                            }
                        }

                        // Destruction de l'élément dans 10 secondes
                        window.setTimeout(function(id) {
                            let toDelete = document.getElementById("media-item-" + id);
                            if(toDelete !== null) {
                                toDelete.parentNode.removeChild(toDelete);
                            }
                        }, 10000, takedMedia);

                        // On enlève la classe invisible du nouveau média
                        newMedia.classList.remove("invisible");

                        // On transforme le média armé en media joué
                        takedMedia = armedMedia;

                        // On vide l'ID du média armé
                        armedMedia = null;

                        // On lance la lecture du nouveau média si besoin
                        mediaPlay(takedMedia);
                    }
                }
            }


            /**
            * Lance la lecture du media défini par l'ID indiqué
            */
            function mediaPlay(id) {
                // On récupère le média
                let mediaItem = document.getElementById("media-item-" + id);
                if(mediaItem!==null) {
                    // On vérifie si le type de media est compatible avec cette commande
                    if(mediaItem.classList.contains("video")) {
                        // On récupère les 2 objets et on lance la lecture
                        let foregroundObj = document.getElementById("media-item-obj-foreground-" + id);
                        let backgroundObj = document.getElementById("media-item-obj-foreground-" + id);

                        if(foregroundObj !== null)
                            foregroundObj.play();
                        
                        if(backgroundObj !== null)
                            backgroundObj.play();
                    }
                }
            }


            // Connexion au socket
            var socket = io.connect(socketAddr);

            // A la réception d'un socket media_command
            socket.on('media_command', function(data) {
                if(data.command!==undefined && data.viewer!==undefined && data.args!==undefined) {
                    const command = data.command;
                    const viewer = data.viewer;
                    const target = data.target ?? null;
                    const args = data.args;

                    console.log("Websocket received for viewer ID \"" + viewer + "\"");

                    if(viewerID == viewer) {
                        console.log("   It's me! Processing the command...");

                        switch(command) {
                            case "arm":
                                if (args.type!==undefined && args.src!==undefined && args.credit!==undefined && args.volume!==undefined && args.loop!==undefined) {
                                    console.log("Arming media.");
                                    mediaArm(args.type, args.src, args.credit, args.volume/100, args.loop);
                                }
                                else {
                                    console.error("'arm' command needs the following args: type, src, credit, volume, loop.", args);
                                }

                                break;
                            
                            case "take":
                                takeArmed();
                                playMedia(takedMedia);
                                console.log("Playing armed media.");
                                break;
                        }

                    }
                    else {
                        console.log("   Not me. Abort.");
                    }
                }
                else {
                    console.error("Invalid media_command websocket datas received.", data);
                }
            });
        </script>
        <script>
            window.setInterval(function() {
                let videos_master = document.querySelectorAll(".media_foreground video");
                let videos_slave = document.querySelectorAll(".media_background video");

                for(let k = 0; k < videos_master.length; k++) {
                    let vm = videos_master[k];
                    let vs = videos_slave[k];

                    vs.currentTime = vm.currentTime+0.01;
                }
            }, 1000);
        </script>
    </body>
</html>