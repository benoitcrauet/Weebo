{% extends "_layout.jinja2" %}

{% block title %}
    {% if guid == None %}
        Créer une émission
    {% else %}
        Modifier une émission - {{ show.name }}
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-6">
                {% if show.id == None %}
                    <h1>Nouvelle émission</h1>
                {% else %}
                    <h1>Modifier une émission</h1>
                    <h2>{{ show.name }}</h2>
                {% endif %}
            </div>
            <div class="col-6 text-end">
                <a href="{{ url_for("shows.shows") }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Retour</a>
            </div>
        </div>

        {% if not guid == None %}
            <div class="accordion mb-3" id="accordionDetails">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#channelDetails" aria-expanded="false" aria-controls="collapseOne">
                            Comment intégrer l'espion de cette émission sur OBS ?
                        </button>
                    </div>
                    <div id="channelDetails" class="accordion-collapse collapse" data-bs-parent="#accordionDetails">
                        <div class="accordion-body">
                            <p>
                                Afin d'avoir les fonctionnalités complètes de Weebo sur cette émission, vous devez intégrer une source spéciale qui "espionne" votre logiciel OBS.<br>
                                Pour l'intégrer, vous devez simplement ajouter une source "<b><i>Navigateur Web</i></b>" (ou "<b><i>Browser</i></b>") dans votre configuration.<br>
                                Vous trouverez ci-dessous les paramètres à saisir dans la source OBS :
                            </p>

                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <th scope="row">
                                            URL (à copier/coller)
                                        </th>
                                        <td>
                                            <input type="text" class="form-control" style="font-family: monospace;" readonly value="{{ config["web"]["baseUrl"] }}{{ url_for("spy.spy", show_guid=show.id) }}" onclick="this.select();">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            Désactiver la source quand elle n'est pas visible
                                        </th>
                                        <td>
                                            Non
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            Rafraîchir le navigateur lorsque la scène devient active
                                        </th>
                                        <td>
                                            Non
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            Permissions de la page
                                        </th>
                                        <td>
                                            Accès complet à OBS
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <form action="" method="post" enctype="multipart/form-data">

            {% if form.errors.values() %}
                <div class="alert alert-danger">
                    Pas si vite ! Les erreurs suivantes ont été détectées :
                    <ul class="mt-2">
                        {% for field, errors in form.errors.items() %}
                            {% for error in errors %}
                                <li>{{ form[field].label.text }} : {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <fieldset>
                <legend>Général</legend>

                <div class="mb-3 row">
                    {{ form.name.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        {{ form.name(class="form-control") }}
                        {% if form.name.description %}<div class="form-text">{{ form.name.description }}</div>{% endif %}
                    </div>
                </div>

                <div class="mb-3 row">
                    {{ form.description.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        {{ form.description(class="form-control") }}
                        {% if form.description.description %}<div class="form-text">{{ form.description.description }}</div>{% endif %}
                    </div>
                </div>

                <div class="mb-3 row">
                    {{ form.logo.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        {{ form.logo(class="form-control") }}
                        {% if form.logo.description %}<div class="form-text">{{ form.logo.description }}</div>{% endif %}
                    </div>
                </div>
                {% if show.logo!=None and show.logo!="" %}
                    <div class="row">
                        <div class="col-sm-3"></div>
                        <div class="col-sm-9 text-center">
                            <img src="/images/{{ show.logo }}" class="img-thumbnail" alt="" style="width: 100px; height: 100px; object-fit: cover;">
                            <br>
                            {{ form.logo_delete() }}
                            {{ form.logo_delete.label }}
                        </div>
                    </div>
                {% endif %}

            </fieldset>

            <fieldset>
                <legend>Paramètres de transcodage vidéo</legend>

                <div class="mb-3 row">
                    {{ form.videoWidth.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        {{ form.videoWidth(class="form-control") }}
                        {% if form.videoWidth.description %}<div class="form-text">{{ form.videoWidth.description }}</div>{% endif %}
                    </div>
                </div>

                <div class="mb-3 row">
                    {{ form.videoHeight.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        {{ form.videoHeight(class="form-control") }}
                        {% if form.videoHeight.description %}<div class="form-text">{{ form.videoHeight.description }}</div>{% endif %}
                    </div>
                </div>

                <div class="mb-3 row">
                    {{ form.videoQuality.label(class="col-form-label col-sm-3") }}
                    <div class="col-sm-9">
                        <div class="row">
                            <div class="col-10">
                                <input type="range" class="form-range" name="videoQuality" id="{{ form.videoQuality.id }}" min="0" max="1" step="0.1" value="{{ show.videoQuality or 0.5 }}" oninput="document.getElementById('videoQualityOutput').innerText = this.value*100 + ' %';">
                            </div>
                            <div class="col-2 text-nowrap" id="videoQualityOutput">
                                {{ math.floor((show.videoQuality or 0)*100 or 50) }} %
                            </div>
                        </div>
                        {% if form.videoQuality.description %}<div class="form-text">{{ form.videoQuality.description }}</div>{% endif %}
                    </div>
                </div>

            </fieldset>

            <div class="col-12">
                {{ form.hidden_tag() }}
                {{ form.id }}
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>


        
    </div>
{% endblock %}